<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Module Repository</title>

<style>
:root{
  --bg:#f2f2f7;
  --card:#ffffff;
  --accent:#007aff;
  --danger:#ff3b30;
  --text:#1c1c1e;
  --sub:#6e6e73;
}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
body{margin:0;background:var(--bg);color:var(--text)}
header{
  padding:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  max-width:1000px;
  margin:auto;
}
header h1{font-size:20px;margin:0}

/* ADMIN BAR - DIPERBAIKI */
.admin-bar{
  display:flex;
  gap:8px;
  align-items:center;
  height:35px; /* Tinggi tetap */
}
.admin-bar input{
  flex:1;
  min-width:130px; /* Penting untuk flex shrink */
  max-width:180px; /* Batasi lebar input */
  padding:8px 12px; /* Padding lebih konsisten */
  height:100%; /* Isi tinggi container */
  border-radius:10px;
  border:1px solid #ddd;
  font-size:13px;
  margin:0; /* Hilangkan margin default */
}
.admin-bar button{
  flex-shrink:0; /* Tombol tidak mengecil */
  padding:8px 16px; /* Padding lebih lebar */
  height:100%; /* Isi tinggi container */
  border:none;
  border-radius:10px;
  background:var(--accent);
  color:#fff;
  font-size:13px;
  font-weight:600;
  white-space:nowrap; /* Tekst tidak wrap */
  cursor:pointer;
}

.container{max-width:1000px;margin:auto;padding:12px}
.card{
  background:var(--card);
  border-radius:18px;
  padding:16px;
  margin-bottom:14px;
  box-shadow:0 8px 24px rgba(0,0,0,.06)
}

input,textarea{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #ddd;
  margin-bottom:10px;
  font-size:14px
}
textarea{resize:vertical}

button{
  padding:10px 16px;
  border:none;
  border-radius:14px;
  background:var(--accent);
  color:#fff;
  font-weight:600;
  cursor:pointer
}
button.gray{background:#8e8e93}
button.danger{background:var(--danger)}

.flex{display:flex;gap:10px;flex-wrap:wrap}
.hidden{display:none}

/* MODULE */
.module-title{font-size:17px;font-weight:600;margin-bottom:6px}
.module-desc{font-size:14px;color:var(--sub);margin-bottom:10px}
.module-meta{
  display:flex;
  gap:8px;
  align-items:center;
  margin-bottom:12px
}
.pill{
  background:#f0f0f5;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
}
.date{font-size:12px;color:var(--sub)}
.actions{display:flex;gap:10px}
.actions a{flex:1;text-decoration:none}
.actions button{width:100%}

/* STATS */
.stats{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:14px;
  color:var(--sub)
}
</style>
</head>

<body>

<header>
  <h1>üì¶ Module Repository</h1>

  <!-- ADMIN LOGIN COMPACT -->
  <div id="loginBar" class="admin-bar">
    <input id="adminPass" type="password" placeholder="Admin password">
    <button onclick="login()">Login</button>
  </div>

  <div id="adminInfo" class="admin-bar hidden">
    <span style="font-size:13px;color:#28a745;">Admin</span>
    <button class="gray" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">

<!-- ADMIN PANEL -->
<div id="adminPanel" class="card hidden">
  <h3>‚öôÔ∏è Admin Panel</h3>
  <input id="ghToken" type="password" placeholder="GitHub Token (wajib)">
  <button class="gray" onclick="saveToken()">Simpan Token</button>

  <hr style="margin:14px 0;border:none;border-top:1px solid #eee">

  <input id="mName" placeholder="Nama module">
  <input id="mVer" placeholder="Versi">
  <input id="mLink" placeholder="Link download">
  <textarea id="mDesc" placeholder="Deskripsi"></textarea>

  <button onclick="addModule()">‚ûï Tambah Module</button>
</div>

<!-- SEARCH + STATS -->
<div class="card">
  <input id="search" placeholder="üîç Cari module (nama / deskripsi)" oninput="render()">
  <div class="stats">
    <span>üì¶ Total Module:</span>
    <strong id="totalCount">0</strong>
  </div>
</div>

<!-- LIST -->
<div id="list"></div>

</div>

<script>
const ADMIN_PASSWORD="adminsiroha";
const OWNER="rahmatsobrian";
const REPO="module";
const BRANCH="main";
const PATH="magisk-modules.json";
const API="https://api.github.com";

let modules=[], isAdmin=false, fileSha=null;

const token=()=>sessionStorage.getItem("gh_token");

/* AUTH */
function login(){
  if(adminPass.value===ADMIN_PASSWORD){
    isAdmin=true;
    loginBar.classList.add("hidden");
    adminInfo.classList.remove("hidden");
    adminPanel.classList.remove("hidden");
  } else alert("Password salah");
}
function logout(){
  isAdmin=false;
  sessionStorage.removeItem("gh_token");
  loginBar.classList.remove("hidden");
  adminInfo.classList.add("hidden");
  adminPanel.classList.add("hidden");
}
function saveToken(){
  if(!ghToken.value) return alert("Token kosong");
  sessionStorage.setItem("gh_token",ghToken.value);
  alert("Token siap");
}

/* GITHUB */
async function load(){
  const r=await fetch(`${API}/repos/${OWNER}/${REPO}/contents/${PATH}?ref=${BRANCH}`);
  const d=await r.json();
  fileSha=d.sha;
  modules=JSON.parse(atob(d.content.replace(/\n/g,""))).modules||[];
  render();
}
async function save(){
  if(!token()) throw "NO_TOKEN";
  const body={
    message:`Update modules ${new Date().toISOString()}`,
    content:btoa(unescape(encodeURIComponent(JSON.stringify({modules},null,2)))),
    sha:fileSha,
    branch:BRANCH
  };
  const r=await fetch(`${API}/repos/${OWNER}/${REPO}/contents/${PATH}`,{
    method:"PUT",
    headers:{Authorization:"token "+token(),"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });
  if(!r.ok) throw "SAVE_FAIL";
}

/* MODULE */
async function addModule(){
  if(!isAdmin) return;
  if(!token()) return alert("Isi token dulu");
  if(!mName.value||!mLink.value) return alert("Nama & link wajib");

  const backup=[...modules];
  modules.unshift({
    id:Date.now(),
    name:mName.value,
    version:mVer.value||"Unknown",
    link:mLink.value,
    description:mDesc.value||"-",
    date:new Date().toLocaleDateString("id-ID")
  });

  try{
    await save(); await load();
    mName.value=mVer.value=mLink.value=mDesc.value="";
  }catch{
    modules=backup;
    alert("Gagal simpan");
  }
}
async function del(id){
  if(!isAdmin||!token()) return;
  const backup=[...modules];
  modules=modules.filter(m=>m.id!==id);
  try{await save();await load();}
  catch{modules=backup;}
}

/* UI */
function render(){
  const q=search.value.toLowerCase();
  const filtered=modules.filter(m=>
    m.name.toLowerCase().includes(q) ||
    m.description.toLowerCase().includes(q)
  );

  totalCount.textContent=filtered.length;
  list.innerHTML="";

  filtered.forEach(m=>{
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`
      <div class="module-title">${esc(m.name)}</div>
      <div class="module-desc">${esc(m.description)}</div>
      <div class="module-meta">
        <span class="pill">v${esc(m.version)}</span>
        <span class="date">${m.date}</span>
      </div>
      <div class="actions">
        <a href="${esc(m.link)}" target="_blank"><button>Download</button></a>
        ${isAdmin?`<button class="danger" onclick="del(${m.id})">Delete</button>`:""}
      </div>`;
    list.appendChild(c);
  });
}
function esc(t){
  return t.replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",
    '"':"&quot;","'":"&#039;"
  }[m]));
}

load();
</script>

</body>
</html>

