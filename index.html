<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Module Repository</title>

<style>
/* === UI ASLI (TIDAK DIUBAH) === */
:root{
  --bg:#f2f2f7;
  --card:#ffffff;
  --accent:#007aff;
  --danger:#ff3b30;
  --text:#1c1c1e;
  --sub:#6e6e73;
}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
body{margin:0;background:var(--bg);color:var(--text)}
header{
  padding:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  max-width:1000px;
  margin:auto;
}
header h1{font-size:20px;margin:0}

.admin-bar{
  display:flex;
  gap:8px;
  align-items:center;
  height:35px;
}
.admin-bar input{
  flex:1;
  min-width:130px;
  max-width:180px;
  padding:8px 12px;
  height:100%;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:13px;
  margin:0;
}
.admin-bar button{
  flex-shrink:0;
  padding:8px 16px;
  height:100%;
  border:none;
  border-radius:10px;
  background:var(--accent);
  color:#fff;
  font-size:13px;
  font-weight:600;
  white-space:nowrap;
  cursor:pointer;
}

.container{max-width:1000px;margin:auto;padding:12px}
.card{
  background:var(--card);
  border-radius:18px;
  padding:16px;
  margin-bottom:14px;
  box-shadow:0 8px 24px rgba(0,0,0,.06)
}

input,textarea{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #ddd;
  margin-bottom:10px;
  font-size:14px
}
textarea{resize:vertical}

button{
  padding:10px 16px;
  border:none;
  border-radius:14px;
  background:var(--accent);
  color:#fff;
  font-weight:600;
  cursor:pointer
}
button.gray{background:#8e8e93}
button.danger{background:var(--danger)}

.hidden{display:none}

.module-title{font-size:17px;font-weight:600;margin-bottom:6px}
.module-desc{font-size:14px;color:var(--sub);margin-bottom:10px}
.module-meta{
  display:flex;
  gap:8px;
  align-items:center;
  margin-bottom:12px
}
.pill{
  background:#f0f0f5;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
}
.date{font-size:12px;color:var(--sub)}
.actions{display:flex;gap:10px}
.actions a{flex:1;text-decoration:none}
.actions button{width:100%}

.stats{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:14px;
  color:var(--sub)
}

.api-limit{
  margin-top:8px;
  font-size:13px;
  display:flex;
  justify-content:space-between;
  color:var(--sub)
}
</style>
</head>

<body>

<header>
  <h1>üì¶ Module Repository</h1>

  <div id="loginBar" class="admin-bar">
    <input id="adminPass" type="password" placeholder="Admin password">
    <button onclick="login()">Login</button>
  </div>

  <div id="adminInfo" class="admin-bar hidden">
    <span style="font-size:13px;color:#28a745;">Admin</span>
    <button class="gray" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">

<div id="adminPanel" class="card hidden">
  <h3>‚öôÔ∏è Admin Panel</h3>
  <input id="ghToken" type="password" placeholder="GitHub Token (wajib)">
  <button class="gray" onclick="saveToken()">Simpan Token</button>

  <hr style="margin:14px 0;border:none;border-top:1px solid #eee">

  <input id="mName" placeholder="Nama module">
  <input id="mVer" placeholder="Versi">
  <input id="mLink" placeholder="Link download">
  <textarea id="mDesc" placeholder="Deskripsi"></textarea>

  <button onclick="addModule()">‚ûï Tambah Module</button>
</div>

<div class="card">
  <input id="search" placeholder="üîç Cari module (nama / deskripsi)" oninput="render()">

  <div class="stats">
    <span>üì¶ Total Module:</span>
    <strong id="totalCount">0</strong>
  </div>

  <div class="api-limit">
    <span>üîó GitHub API:</span>
    <strong id="apiLimitText">Loading‚Ä¶</strong>
  </div>

  <!-- INFO MODE (TAMBAHAN, TANPA MERUSAK LAYOUT) -->
  <div class="api-limit">
    <span>‚öôÔ∏è Mode:</span>
    <strong id="modeText">API</strong>
  </div>
</div>

<div id="list"></div>
</div>

<script>
/* ===== CONFIG ===== */
const ADMIN_PASSWORD="adminsiroha";
const OWNER="rahmatsobrian";
const REPO="module";
const BRANCH="main";
const PATH="magisk-modules.json";

const API_URL=`https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}?ref=${BRANCH}`;
const RAW_URL=`https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${PATH}`;

let modules=[], isAdmin=false, fileSha=null;
let MODE="API"; // API | RAW
const token=()=>sessionStorage.getItem("gh_token");

/* ===== AUTH ===== */
function login(){
  if(adminPass.value===ADMIN_PASSWORD){
    isAdmin=true;
    loginBar.classList.add("hidden");
    adminInfo.classList.remove("hidden");
    adminPanel.classList.remove("hidden");
    render();
  } else alert("Password salah");
}
function logout(){
  isAdmin=false;
  sessionStorage.removeItem("gh_token");
  loginBar.classList.remove("hidden");
  adminInfo.classList.add("hidden");
  adminPanel.classList.add("hidden");
  checkApiLimit();
  render();
}
function saveToken(){
  if(!ghToken.value) return alert("Token kosong");
  sessionStorage.setItem("gh_token",ghToken.value);
  alert("Token berhasil tersimpan");
  checkApiLimit();
}

/* ===== LOAD DATA (API ‚Üí RAW FALLBACK) ===== */
async function load(){
  try{
    const r=await fetch(API_URL);
    if(!r.ok) throw "API_FAIL";
    const d=await r.json();
    fileSha=d.sha;
    modules=JSON.parse(atob(d.content.replace(/\n/g,""))).modules||[];
    MODE="API";
    modeText.textContent="API";
  }catch{
    const r=await fetch(RAW_URL);
    const d=await r.json();
    modules=d.modules||[];
    MODE="RAW";
    modeText.textContent="RAW";
  }
  render();
}

/* ===== SAVE ===== */
async function save(){
  if(MODE!=="API") throw "READ_ONLY";
  const body={
    message:`Update modules ${new Date().toISOString()}`,
    content:btoa(unescape(encodeURIComponent(JSON.stringify({modules},null,2)))),
    sha:fileSha,
    branch:BRANCH
  };
  await fetch(API_URL,{
    method:"PUT",
    headers:{
      Authorization:"token "+token(),
      "Content-Type":"application/json"
    },
    body:JSON.stringify(body)
  });
}

/* ===== ADD / DELETE ===== */
async function addModule(){
  if(!isAdmin) return;
  if(MODE!=="API") return alert("Cant add module, because RAW Mode");
  if(!token()) return alert("Isi token dulu");
  if(!mName.value||!mLink.value) return alert("Nama & link wajib");

  modules.unshift({
    id:Date.now(),
    name:mName.value,
    version:mVer.value||"Unknown",
    link:mLink.value,
    description:mDesc.value||"-",
    date:new Date().toLocaleDateString("id-ID")
  });

  await save();
  await load();
  mName.value=mVer.value=mLink.value=mDesc.value="";
}

async function del(id){
  if(!isAdmin || MODE!=="API") return;
  if(!token()){
    alert("Silakan masukkan dan simpan Token Github terlebih dahulu");
    return;
  }
  if(!confirm("Yakin ingin menghapus module ini?")) return;
  modules = modules.filter(m => m.id !== id);
  await save();
  await load();
}

/* ===== RENDER ===== */
function render(){
  const q=search.value.toLowerCase();
  const filtered=modules.filter(m=>
    m.name.toLowerCase().includes(q) ||
    m.description.toLowerCase().includes(q)
  );
  totalCount.textContent=filtered.length;
  list.innerHTML="";
  filtered.forEach(m=>{
    list.innerHTML+=`
      <div class="card">
        <div class="module-title">${esc(m.name)}</div>
        <div class="module-desc">${esc(m.description)}</div>
        <div class="module-meta">
          <span class="pill">v${esc(m.version)}</span>
          <span class="date">${m.date}</span>
        </div>
        <div class="actions">
          <a href="${esc(m.link)}" target="_blank"><button>Download</button></a>
          ${isAdmin && MODE==="API"
            ? `<button class="danger" onclick="del(${m.id})">Delete</button>`
            : ""}
        </div>
      </div>`;
  });
}

/* ===== API LIMIT ===== */
async function checkApiLimit(){
  try{
    const headers={};
    if(isAdmin && token()) {
  headers.Authorization = "token " + token();
}
    const r=await fetch("https://api.github.com/rate_limit",{headers});
    const d=await r.json();
    const {remaining,limit,reset}=d.rate;

    const t=new Date((reset+7*3600)*1000);
    const jam=String(t.getUTCHours()).padStart(2,"0");
    const menit=String(t.getUTCMinutes()).padStart(2,"0");

    if(remaining===0){
      apiLimitText.innerHTML=`<span style="color:#FF1300;font-weight:600">Limit Reached</span> Reset ${jam}.${menit} WIB`;
      MODE="RAW";
      modeText.textContent="RAW";
      return;
    }

    let color="#007AFF";
    if(remaining<100) color="#007AFF";
    if(remaining<60) color="#4CD964";
    if(remaining<30) color="#FF9500";
    if(remaining<10) color="#FF1300";

    apiLimitText.innerHTML=`<span style="color:${color}">[${remaining}/${limit}]</span> Reset ${jam}.${menit} WIB`;
  }catch{
    apiLimitText.textContent=`<span style="color:#FF1300;font-weight:600">Unavailable</span>`;
  }
}

function esc(t){
  return t.replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",
    '"':"&quot;","'":"&#039;"
  }[m]));
}

load();
checkApiLimit();
setInterval(checkApiLimit,60000);
</script>

</body>
</html>
